# トランザクション × 状態遷移ガード条件

本ドキュメントでは、Async Job Executor における  
**タスクのライフサイクル・トランザクション境界・状態遷移ガード条件** の対応関係を整理します。

本システムは非同期・再実行前提で設計されているため、  
**状態遷移の正当性を DB レベルで保証すること**を重要な設計方針としています。

---

## 基本的な考え方

本システムでは、以下の 3 点を必ずセットで設計します。

- **ライフサイクル**  
  タスクがどの状態を取り、どのように遷移するか

- **トランザクション**  
  その遷移を「事実として確定」させる最小単位

- **ガード条件**  
  不正な状態遷移や同時実行を防止する制約条件

状態遷移は、  
**ガード条件付きの UPDATE をトランザクション内で実行**することで  
原子的に制御します。

---

## Task 状態遷移ごとの対応関係

### 1. Task 作成

`(なし) → PENDING`

| 項目             | 内容                               |
| ---------------- | ---------------------------------- |
| トリガー         | API によるタスク登録               |
| トランザクション | `INSERT INTO tasks`                |
| ガード条件       | なし                               |
| 設計意図         | タスク登録の事実を確実に永続化する |

---

### 2. 実行開始

`PENDING → RUNNING`

| 項目             | 内容                             |
| ---------------- | -------------------------------- |
| トリガー         | Worker がキューを取得            |
| トランザクション | Task 更新 + TaskExecution 作成   |
| ガード条件       | `tasks.status = 'PENDING'`       |
| 防止できる問題   | 同一タスクの多重実行             |
| 設計意図         | 実行権を 1 Worker のみに付与する |

**補足**  
ガード条件付き UPDATE が失敗した場合、  
そのタスクはすでに他の Worker により処理中、または完了済みと判断します。

---

### 3. 実行成功

`RUNNING → COMPLETED`

| 項目             | 内容                                                        |
| ---------------- | ----------------------------------------------------------- |
| トリガー         | Worker の正常終了                                           |
| トランザクション | TaskExecution 更新 + Task 更新                              |
| ガード条件       | `execution.status = 'RUNNING'`<br>`task.status = 'RUNNING'` |
| 防止できる問題   | 二重完了・競合更新                                          |
| 設計意図         | 最新の試行結果のみを正とする                                |

---

### 4. 実行失敗

`RUNNING → FAILED`

| 項目             | 内容                                                        |
| ---------------- | ----------------------------------------------------------- |
| トリガー         | Worker 実行中のエラー                                       |
| トランザクション | TaskExecution 更新 + Task 更新                              |
| ガード条件       | `execution.status = 'RUNNING'`<br>`task.status = 'RUNNING'` |
| 防止できる問題   | 二重失敗・状態破壊                                          |
| 設計意図         | 失敗理由を履歴として確定する                                |

---

### 5. 再実行

`FAILED → RUNNING`

| 項目             | 内容                               |
| ---------------- | ---------------------------------- |
| トリガー         | API または自動リトライ             |
| トランザクション | Task 更新 + 新 TaskExecution 作成  |
| ガード条件       | `tasks.status = 'FAILED'`          |
| 防止できる問題   | 完了済みタスクの再実行             |
| 設計意図         | 再実行を明示的な状態遷移として扱う |

---

## TaskExecution の状態遷移

TaskExecution は短命なエンティティであり、  
以下の単純な状態遷移のみを持ちます。

| 遷移                | ガード条件           | トランザクション |
| ------------------- | -------------------- | ---------------- |
| `RUNNING → SUCCESS` | `status = 'RUNNING'` | Execution 更新   |
| `RUNNING → FAILED`  | `status = 'RUNNING'` | Execution 更新   |

Task と TaskExecution の更新は、  
必要に応じて同一トランザクションで実行します。

---

## ガード条件付き UPDATE を採用する理由

### 1. 原子性の確保

`SELECT → UPDATE` の分離による競合を防ぎ、  
1 文の SQL で状態遷移を完結させます。

### 2. 非同期・重複配送への耐性

メッセージの重複配送（at-least-once）を  
異常ではなく正常系として扱える設計とします。

---

## 設計の要点まとめ

- 状態遷移は **業務ルール**
- トランザクションは **事実の確定**
- ガード条件は **業務ルールの強制**

この 3 点が常に対応するよう設計することで、  
非同期・分散環境でも破綻しない実行モデルを実現します。
