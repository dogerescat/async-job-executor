# トランザクション方針

本ドキュメントでは、Async Job Executor における  
**トランザクションの境界と設計方針**について説明します。

本システムは非同期処理を前提としており、  
外部 API 呼び出しやファイル生成などの長時間処理を含みます。  
そのため、トランザクションは **最小限かつ明確な範囲** に限定する方針を採用しています。

---

## 基本方針

本システムにおけるトランザクション設計の基本方針は以下の通りです。

- トランザクションは **DB 内の状態確定のみ** に使用する
- 外部 I/O や長時間処理は **トランザクション外** で実行する
- 冪等性と再実行を前提とした設計とする
- 状態遷移の正当性は **ガード条件** により保証する

これにより、  
ロック競合やトランザクション肥大化を防ぎ、  
障害時のリカバリを容易にします。

---

## トランザクション境界の考え方

トランザクションの境界は、  
**「システムとして事実を確定させたい最小単位」** を基準に定義します。

- Task が登録されたという事実
- TaskExecution が開始・完了・失敗したという事実
- Task の状態が遷移したという事実

これらは **原子的に記録される必要があります**。

一方で、

- 外部 API 呼び出し
- Excel ファイル生成
- ファイル保存処理

などは、  
再実行可能であることが重要であり、  
トランザクションの対象外とします。

---

## API 側のトランザクション

### タスク登録

- API により Task を登録する際、
  - `tasks` テーブルへの INSERT のみをトランザクションで保護
- キューへのメッセージ送信はトランザクション外で実施

これにより、

- DB とキューの分散トランザクションを回避
- タスク登録の事実を確実に残す

設計としています。

---

### 再実行要求

- 再実行要求は Task の状態更新として記録
- 実際の実行は Worker に委譲

API は **実行のトリガーのみ** を担当します。

---

## Worker 側のトランザクション

### 実行開始時

Worker がタスクの実行を開始する際、  
以下を 1 トランザクションで行います。

- Task の状態を `RUNNING` に更新（ガード条件付き）
- 新しい TaskExecution を作成

これにより、

- 同一 Task の多重実行を防止
- 実行開始の事実を確実に記録

します。

---

### 実行処理中

以下の処理は **トランザクション外** で実行します。

- 外部 API 呼び出し
- レスポンスの解析
- Excel ファイル生成

途中経過やエラーはログとして記録しますが、  
DB の状態は変更しません。

---

### 実行成功時

実行が成功した場合、以下を 1 トランザクションで行います。

- TaskExecution を `SUCCESS` に更新
- Task を `COMPLETED` に更新

これにより、
Task と最新の TaskExecution の整合性を保ちます。

---

### 実行失敗時

実行が失敗した場合、以下を 1 トランザクションで行います。

- TaskExecution を `FAILED` に更新
- エラーコード・エラーメッセージを記録
- Task を `FAILED` に更新

失敗理由を明確に残すことで、
後続の再実行判断や障害調査を容易にします。

---

## 冪等性と再実行

本システムでは、  
**メッセージの重複配送や Worker の再起動を前提** としています。

- 同一タスクが複数回実行開始されても壊れない設計
- 状態遷移はガード条件付きで制御
- 再実行は新しい TaskExecution として扱う

これにより、
at-least-once 配送モデルに適合します。

---

## 設計意図まとめ

本トランザクション方針は、

- 非同期処理に適した短いトランザクション
- 再実行可能な処理モデル
- 運用・障害対応に強い構造

を実現することを目的としています。
